---
создал заметку: 20-10-2025
tags:
  - embedded
  - Linux
---
### Описание
Начальный загрузчик - это второй элемент встраиваемой Linux-системы. Он запускает устройство и загружает ядро операционной системы, передает управление ядру с помощью структуры данных, называемой деревом устройств, или линеаризованным деревом устройств (*flattened device tree - FDT*).

Во [[Встраиваемая система (embedded-system)]] Linux начальный загрузчик решает две задачи: базовая инициализация и загрузка ядра.

### Последовательность начальной загрузки
#### Этап 1: код в ПЗУ
##### Код в ПЗУ (ROM code - Read-Only Memory)
- **Назначение:** Исполняется сразу после сброса/включения. Хранится на кристалле SoC (System on Chip), неизменяем.
- **Ограничения:** Не имеет доступа к внешней памяти (даже DRAM - Dynamic Random-Access Memory). Работает только с небольшой встроенной SRAM (Static Random-Access Memory, 4 КБ - сотни КБ).

- **Процесс:** Код ПЗУ пытается загрузить начальный загрузчик в SRAM из предопределённых мест:
    1. Флэш-память (NAND, SPI - Serial Peripheral Interface)
    2. MMC-устройство (MultiMediaCard: eMMC - embedded MultiMediaCard или SD - Secure Digital карта)
    3. Сеть (Ethernet, USB, UART - Universal Asynchronous Receiver-Transmitter) - в основном для отладки/производства.

- **Результат этапа:** Управление передаётся загруженному в SRAM загрузчику (SPL или основному).

![[Pasted image 20251020181136.png]]
#### Этап 2: SPL

##### SPL (Secondary Program Loader - вторичный загрузчик программ)
- **Назначение:** Промежуточный загрузчик, используется если основной загрузчик (например, U-Boot) не помещается в SRAM.

- **Основная задача:** Настройка контроллера памяти и системных компонентов для подготовки к загрузке TPL (Third stage Program Loader) в DRAM.
- **Ограничения:** Функциональность ограничена размером SPL.
- **Функции:**
    - Загрузка программы с запоминающих устройств (с предопределенного смещения или из файла `u-boot.bin`)
    - Минимальное взаимодействие с пользователем (может выводить версию и прогресс)
- **Статус кода:** Может быть открытым (TI x-loader, Atmel AT91Bootstrap) или закрытым (проприетарные двоичные файлы).
- **Результат этапа:** TPL загружен в DRAM, управление передается ему.
![[Pasted image 20251021131205.png]]

#### Этап 3: TPL

##### TPL (Third Stage Program Loader - третичный загрузчик программ)
- **Представители:** U-Boot, Barebox
- **Функционал:** Полнофункциональный начальный загрузчик
##### Основные задачи TPL
- **Интерфейс:** Простой командный интерфейс для обслуживания
- **Операции:**
  - Загрузка новых образов (загрузочных, ядра) во флэш-память
  - Чтение и загрузка ядра
  - Автоматическая загрузка ядра (без вмешательства пользователя)
##### Процесс загрузки
- Загружает в SDRAM (Synchronous Dynamic RAM):
  - Образ ядра
  - FDT (Flattened Device Tree - дерево устройств)
  - initramdisk (временная корневая ФС)
##### Завершение этапа
- Ядро размещено в памяти и готово к работе
- TPL стирается из памяти после запуска ядра
- Не участвует в дальнейшей работе системы

![[Pasted image 20251021143101.png]]

### Переход от начального загрузчика к ядру

**Информация, передаваемая ядру:**
- **Архитектурно-зависимые данные:**
  - PowerPC/ARM: уникальный номер типа SoC (System on Chip)
- **Базовые сведения об оборудовании:**
  - Размер и адрес начала физической оперативной памяти
  - Тактовая частота процессора
- **Командная строка ядра** (ASCII) - определяет поведение Linux
- **Опционально:**
  - Размер и местоположение FDT (Flattened Device Tree - дерево устройств)
  - Размер и местоположение initramdisk (начальный RAM-диск)

#### Эволюция методов передачи данных
**Исторически:**
- **PowerPC:** указатель на структуру с информацией о плате
- **ARM:** указатель на список A-тэгов (A-tags)

**Проблемы старого подхода:**
- Малое количество передаваемой информации
- Необходимость платформенных данных (platform data)
- Требовалась специальная конфигурация ядра для каждого устройства

**Современный подход:**
- **FDT (Flattened Device Tree)** - замена A-тэгам
- **Переход на ARM:** начат в Linux 3.8 (февраль 2013)
- **Текущее состояние:** многие устройства еще используют A-тэги
