---
создал заметку: 27-10-2025
tags:
  - cmake
---
### Описание
Целью использования [[CFLAGS и CXXFLAGS]] является создание кода, приспособленного под систему; он должен отлично функционировать, будучи легковесным и быстрым, если это возможно

#### -march
Самым первым и наиболее важным параметром является `-march`. Он сообщает компилятору, какой код генерировать для [архитектуры процессора](https://en.wikipedia.org/wiki/Microarchitecture "wikipedia:Microarchitecture"); он сообщает GCC, что тот должен генерировать код для определенного типа CPU.
Если тип процессора все еще нее определен, либо не знаете какую настройку выбрать, то можно воспользоваться параметром `-march=native`. Когда используется этот флаг, GCC попытается распознать процессор и автоматически установит для него подходящие флаги. **Однако, не нужно его использовать, если собираетесь компилировать пакеты для разных CPU!**
При сборке пакетов на одном компьютере с целью их запуска на другом (например, при сборке на более быстром компьютере с целью запуска на более старом и медленном) _не_ используйте параметр `-march=native`

#### -O
Следующая по списку - переменная `-O`. Она управляет всем уровнем оптимизации. Изменение этой переменной приводит к тому, что компиляция кода занимает больше времени, и сможет занять гораздо больше памяти, особенно когда уровень оптимизации увеличен.
Существует семь видов настроек переменной `-O`: `-O0`, `-O1`, `-O2`, `-O3`, `-Os`, `-Oz` и `-Og`

- `-O0`: Этот уровень (буква «O» и ноль за ней) отключает оптимизацию полностью и является уровнем по умолчанию, если никакого уровня с префиксом `-O` не указано в переменных CFLAGS или CXXFLAGS. Это сокращает время компиляции и может улучшить данные для отладки, но некоторые приложения не будут работать должным образом без оптимизации. Эта опция не рекомендуется, за исключением использования в целях отладки.

- `-O1`: Это наиболее простой уровень оптимизации. Компилятор попытается сгенерировать быстрый, занимающий меньше объема код, не тратя много времени на компиляцию. Он достаточно простой, но должен всегда выполнять свою работу.

- `-O2`: Шаг вперед от `-O1`. _Рекомендуемый_ уровень оптимизации, до тех пор пока не понадобится что-то особенное. `-O2` активирует несколько дополнительных флагов вдобавок к флагам, активированных `-O1`. С параметром `-O2`, компилятор попытается увеличить производительность кода без нарушения размера, и не тратя много времени на компиляцию. На этом уровне могут быть использованы SSE и AVX, но YMM-регистры не будут использоваться без отдельного включения параметра `-ftree-vectorize`.

- `-O3`: включает `-O2` и оптимизации, являющиеся дорогостоящими с точки зрения времени компиляции и потребления памяти. Компиляция с `-O3`, скорее всего, улучшит производительность (хотя это не гарантируется). Хотя в прошлом использование `-O3` могло вызвать ошибки компиляции, на данный момент проблемы с `-O3` практически всегда являются примерами неопределенного поведения и ошибок в коде, который необходимо исправлять. Некоторые пакеты до сих пор не могут использоваться после компиляции `-O3`. Использование `-O3` не рекомендуется (если только пакеты после этого не подвергаются тестированию). Однако, этот параметр также включает `-ftree-vectorize`, при котором применяется векторизация циклов и используются регистры AVX YMM.

- `-Ofast`: Новое в GCC 4.7, состоит из `-O3` plus `-ffast-math`, `-fno-protect-parens`, `-fallow-store-data-races`, `-fstack-arrays` и `-fno-semantic-interposition`. Этот параметр нарушает строгое соответствие стандарту, и не рекомендуется для использования. Никогда не используйте этот флаг для всей системы, только для конкретного пакета и только при условии, что программа была протестирована для его использования.

- `-Os`: На этом уровне код будет оптимизирован по объему. Он активирует все параметры `-O2`, которые не приводят к увеличению размера генерируемого кода. Он может быть полезным на компьютерах, которые обладают чрезвычайно ограниченным пространством жесткого диска и/или процессоры с небольшим размером кэша.

- `-Oz`: Этот уровень впервые появился в GCC 12.1 и является более агрессивной оптимизацией по размеру, чем `-Os`. Заметьте, что это может привести к значительному ухудшению производительности по сравнению `-O2`, так как для сокращения размера файла будут использоваться больше инструкций.

- `-Og`: В GCC 4.8 был введен новый общий уровень оптимизации -Og. Он удовлетворяет потребность в быстрой компиляции и имеет превосходные возможности для отладки, обеспечивая при этом приемлемый уровень производительности во время выполнения. Общий опыт разработки должен быть лучше, чем с уровнем оптимизации по умолчанию -O0. Обратите внимание, что -Og не означает -g, он просто отключает оптимизацию кода, которая может помешать отладке.

Как упомянуто ранее, параметр `-O2` - рекомендуемый уровень оптимизации. Если компиляция пакета выдает сообщение об ошибке и не используется параметр `-O2`, то попробуйте перекопилировать с этой опцией. В качестве выхода, попробуйте установить переменные CFLAGS и CXXFLAGS на наименьший уровень оптимизации, такой как `-O1`, или даже `-O0 -g2 -ggdb` (для сообщения об ошибках и проверки возможных проблем).
#### -pipe
Общеупотребительный флаг - `-pipe`. Этот флаг не влияет на генерируемый код, но _ускоряет_ процесс компиляции. Он сообщает компилятору, чтобы тот использовал конвейер (pipe) вместо временных файлов в течение разных стадий компиляции, которые используют большее количество памяти. На системах с небольшим количеством памяти, GCC может завершить свою работу. В этих случаях, не используйте этот флаг.
#### -ftree-vectorize
`-ftree-vectorize` — параметр оптимизации (по умолчанию при `-O3` и `-Ofast`), который по возможности пытается векторизовать циклы с помощью выбранной ISA. Причина, по которой она ранее не включалась при `-O2` — она не всегда улучшает код, может также сделать его медленнее, и обычно делает код больше; зависит от конкретного цикла и т. д
#### -fomit-frame-pointer
Это очень часто используемый флаг, предназначенный для того, чтобы уменьшить размер генерируемого кода. Он включается на всех уровнях с префиксом `-O` (исключая `-O0`) на тех архитектурах, где это не затрудняет отладку (таких как x86-64), но его, возможно, необходимо активировать.

#### -msse, -msse2, -msse3, -mmmx, -m3dnow
Эти флаги разрешают наборы команд [Streaming SIMD Extensions](https://en.wikipedia.org/wiki/Streaming_SIMD_Extensions "wikipedia:Streaming SIMD Extensions") (SSE), [SSE2](https://en.wikipedia.org/wiki/SSE2 "wikipedia:SSE2"), [SSE3](https://en.wikipedia.org/wiki/SSE3 "wikipedia:SSE3"), [MMX](https://en.wikipedia.org/wiki/MMX_\(instruction_set\)_MMX "wikipedia:MMX (instruction set) MMX") и [3DNow!](https://en.wikipedia.org/wiki/3DNow! "wikipedia:3DNow!") для архитектур x86 и x86-64. Они полезны в основном в мультимедиа, играх и других интенсивных вычислениях с использованием чисел с плавающей точкой, хотя они также включают несколько других математических расширений.

### Оптимизация во время связывания (LTO)
LTO значительно увеличивает время компиляции; если хотя бы один объектный файл был изменен во время компиляции, LTO начнет пересборку всего кода целиком.
